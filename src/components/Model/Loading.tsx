import { useLoadingStore } from '@/libs/stores/useLoadingStore';
import { twclsx } from '@/libs/utils';
import { FC, ReactNode, memo, useEffect, useRef, useState } from 'react';
import Progress from './Progress';
import ProgressText from './ProgressText';

const Loading: FC<{ children?: ReactNode }> =
  // eslint-disable-next-line react/display-name
  memo(({ children }) => {
    const progressRef = useRef<HTMLDivElement>(null);
    const progressTextRef = useRef<HTMLDivElement>(null);
    const ref = useRef<HTMLDivElement>(null);
    const percRef = useRef(useLoadingStore.getState().perc);
    // Connect to the store on mount, disconnect on unmount, catch state-changes in a reference
    useEffect(() => {
      useLoadingStore.subscribe((state) => {
        if (progressRef.current && progressTextRef.current && ref.current) {
          const p = `${Math.ceil(state.perc)}%`;
          ;(progressRef.current as HTMLDivElement).style.width = p;
          (progressTextRef.current as HTMLDivElement).innerText = p;
          if (state.perc >= 100 || !state.perc) {
            (ref.current as HTMLDivElement).style.visibility = 'hidden';
          }
          percRef.current = state.perc;
        }
      });
    }, []);

    return (
      <div
        ref={ref}
        className={twclsx('w-full h-full text-[40px] text-black absolute flex items-center justify-center flex-col')}
      >
        <div className="animate-bounce w-[140px]">
          <svg width="139" height="80" viewBox="0 0 139 80" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M84.4863 23.0474C84.475 23.0267 84.4613 23.0075 84.4454 22.9901L67.8056 1.40164C67.4716 0.967585 67.0429 0.615638 66.552 0.372706C66.0612 0.129773 65.5213 0.00228974 64.9737 1.33508e-06H44.133C43.3385 -0.000683433 42.5662 0.262065 41.9369 0.747123C41.3077 1.23218 40.857 1.91218 40.6555 2.68069L36.4424 18.536C36.3053 19.067 36.2914 19.6224 36.4019 20.1596C36.5125 20.6968 36.7444 21.2016 37.08 21.6354C37.4156 22.0692 37.846 22.4205 38.3382 22.6623C38.8304 22.9042 39.3715 23.0303 39.9199 23.031H57.4915C58.0399 23.0317 58.581 23.1578 59.0732 23.3997C59.5654 23.6416 59.9958 23.9928 60.3314 24.4266C60.667 24.8604 60.8989 25.3652 61.0094 25.9024C61.12 26.4396 61.1061 26.995 60.969 27.5261L52.8575 58.3008C52.7163 58.8326 52.6996 59.3899 52.8088 59.9292C52.9179 60.4685 53.1499 60.9755 53.4868 61.4106L65.6234 77.1555C66.0338 77.6865 66.5846 78.092 67.2134 78.3263C67.8423 78.5605 68.5241 78.6142 69.1819 78.4811C69.8396 78.348 70.447 78.0335 70.9353 77.5732C71.4236 77.1129 71.7734 76.5252 71.9451 75.8764L85.0747 26.0999C85.2119 25.5795 85.2302 25.035 85.1283 24.5066C85.0264 23.9782 84.807 23.4795 84.4863 23.0474Z"
              fill="white"
            />
            <path
              d="M138.251 23.0473C138.239 23.0276 138.225 23.0085 138.21 22.9901L121.456 1.39347C121.122 0.960685 120.692 0.610136 120.202 0.36862C119.711 0.127105 119.171 0.00101815 118.624 9.86005e-10L97.8693 9.86004e-10C97.0761 -1.85792e-05 96.3051 0.262557 95.6768 0.746753C95.0484 1.23095 94.598 1.90953 94.3959 2.6766L90.2155 18.536C90.0784 19.067 90.0645 19.6224 90.175 20.1596C90.2856 20.6968 90.5175 21.2016 90.8531 21.6354C91.1887 22.0692 91.6191 22.4205 92.1113 22.6623C92.6035 22.9042 93.1446 23.0303 93.693 23.031H111.265C111.813 23.0315 112.354 23.1575 112.846 23.3994C113.338 23.6414 113.768 23.9927 114.104 24.4267C114.439 24.8606 114.671 25.3655 114.78 25.9028C114.89 26.44 114.876 26.9953 114.738 27.5261L106.655 58.3335C106.514 58.8651 106.497 59.422 106.606 59.9611C106.714 60.5003 106.945 61.0074 107.28 61.4433L119.417 77.1882C119.826 77.7206 120.377 78.1276 121.006 78.3628C121.635 78.598 122.318 78.6521 122.976 78.5188C123.635 78.3856 124.243 78.0705 124.731 77.6092C125.219 77.1479 125.568 76.5589 125.739 75.9091L138.848 26.1081C138.984 25.5858 139 25.0396 138.897 24.5099C138.794 23.9802 138.573 23.4804 138.251 23.0473Z"
              fill="white"
            />
            <path
              d="M19.5696 8.53653C19.1607 8.00404 18.6106 7.59684 17.982 7.36111C17.3533 7.12538 16.6712 7.07057 16.0129 7.2029C15.3547 7.33523 14.7467 7.6494 14.258 8.10976C13.7693 8.57012 13.4193 9.15824 13.2479 9.8074L0.118299 59.6289C-0.021625 60.1609 -0.0376541 60.7178 0.0714451 61.2569C0.180544 61.7961 0.411864 62.303 0.747606 62.7387L12.9701 78.598C13.3796 79.1304 13.9302 79.5374 14.5594 79.7726C15.1886 80.0078 15.8711 80.0619 16.5295 79.9287C17.1879 79.7955 17.7957 79.4803 18.284 79.019C18.7723 78.5577 19.1214 77.9687 19.2917 77.319L32.4214 27.5056C32.5613 26.9737 32.5773 26.4167 32.4682 25.8776C32.3591 25.3385 32.1278 24.8316 31.7921 24.3959L19.5696 8.53653Z"
              fill="white"
            />
            <path
              d="M60.9731 27.5179L52.8616 58.2926C52.7204 58.8245 52.7037 59.3817 52.8129 59.921C52.922 60.4604 53.154 60.9673 53.4909 61.4024L65.6275 77.1473C66.0379 77.6783 66.5887 78.0838 67.2175 78.3181C67.8464 78.5524 68.5282 78.606 69.186 78.4729C69.8437 78.3398 70.4511 78.0253 70.9394 77.565C71.4277 77.1048 71.7775 76.517 71.9492 75.8683L85.0747 26.059C85.2122 25.5387 85.2306 24.9941 85.1287 24.4656C85.0269 23.9372 84.8073 23.4384 84.4863 23.0065H57.4956C58.0458 23.0065 58.5887 23.1328 59.0825 23.3756C59.5762 23.6184 60.0077 23.9713 60.3436 24.4071C60.6795 24.8429 60.911 25.35 61.0201 25.8893C61.1293 26.4286 61.1132 26.9857 60.9731 27.5179Z"
              fill="url(#paint0_linear_9_556)"
            />
            <path
              d="M111.269 23.0065C111.817 23.0069 112.358 23.133 112.85 23.3749C113.342 23.6168 113.772 23.9682 114.108 24.4021C114.443 24.8361 114.675 25.341 114.785 25.8782C114.894 26.4155 114.88 26.9708 114.742 27.5015L106.655 58.2926C106.514 58.8242 106.497 59.3811 106.606 59.9202C106.714 60.4594 106.945 60.9665 107.28 61.4024L119.417 77.1473C119.826 77.6797 120.377 78.0867 121.006 78.3219C121.635 78.5571 122.318 78.6112 122.976 78.478C123.635 78.3448 124.243 78.0296 124.731 77.5683C125.219 77.107 125.568 76.518 125.739 75.8683L138.848 26.0672C138.984 25.5449 139.001 24.9987 138.898 24.469C138.794 23.9392 138.573 23.4394 138.251 23.0065H111.269Z"
              fill="url(#paint1_linear_9_556)"
            />
            <defs>
              <linearGradient
                id="paint0_linear_9_556"
                x1="71.0747"
                y1="46.9937"
                x2="62.3788"
                y2="27.1215"
                gradientUnits="userSpaceOnUse"
              >
                <stop stopColor="white" stopOpacity="0" />
                <stop offset="1" stopColor="#BEBEBE" />
              </linearGradient>
              <linearGradient
                id="paint1_linear_9_556"
                x1="124.488"
                y1="46.1396"
                x2="115.837"
                y2="26.5739"
                gradientUnits="userSpaceOnUse"
              >
                <stop stopColor="white" stopOpacity="0" />
                <stop offset="1" stopColor="#BEBEBE" />
              </linearGradient>
            </defs>
          </svg>
        </div>
        <Progress ref={progressRef} />
        <ProgressText ref={progressTextRef} />
      </div>
    );
  });

export default Loading;
